<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Osakedata Viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        html {
            scroll-behavior: smooth;
        }
        .container {
            margin-top: 2rem;
        }
        .table-container {
            margin-top: 2rem;
            max-height: 75vh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        #stockTable {
            font-size: 0.9em;
        }
        
        /* Varmista ett√§ taulukon otsikot ja data ovat linjassa */
        #stockTable th,
        #stockTable td {
            text-align: left;
            vertical-align: middle;
            padding: 0.5rem;
        }
        
        /* Numeroiden tasaus oikealle */
        #stockTable td:nth-child(n+3):nth-child(-n+7) {
            text-align: right;
        }
        
        /* Symbolien tasaus vasemmalle */
        #stockTable td:first-child,
        #stockTable th:first-child {
            text-align: left;
        }
        .info-box {
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 1rem;
            margin: 1rem 0;
        }
        .error-box {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 1rem;
            margin: 1rem 0;
        }
        .symbol-badge {
            background-color: #007bff;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            margin: 0.1rem;
            display: inline-block;
            transition: all 0.2s ease;
        }
        
        .symbol-badge:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }
        
        .autocomplete-item:hover {
            background-color: #f8f9fa;
        }
        
        #symbol-container {
            min-height: 150px;
        }
        
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        
        /* Smooth scrolling for pagination */
        .page-link {
            transition: all 0.2s ease;
        }
        
        /* Better responsive symbol layout */
        @media (max-width: 768px) {
            .symbol-badge {
                font-size: 0.75rem;
                padding: 0.1rem 0.3rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <h1 class="text-center mb-4">üìà Stock Data Viewer</h1>
                
                <div class="card">
                    <div class="card-header">
                        <h5>Hae tai poista data</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="db_type" class="form-label">Valitse tietokanta:</label>
                            <select class="form-select" id="db_type" name="db_type" onchange="updateDatabase()">
                                <option value="osakedata" {% if not current_db or current_db == 'osakedata' %}selected{% endif %}>
                                    üìä Osakedata (OHLCV-tiedot)
                                </option>
                                <option value="analysis" {% if current_db == 'analysis' %}selected{% endif %}>
                                    üïØÔ∏è Kynttil√§kuvioanalyysi
                                </option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="tickers" class="form-label">Symbolit tai niiden alut (pilkulla erotettuna):</label>
                            <div class="position-relative">
                                <input type="text" class="form-control" id="tickers" name="tickers" 
                                       placeholder="Esim: AAPL, GOOGL tai vain AA, GOO" 
                                       value="{{ request.form.get('tickers', '') or request.form.get('delete_tickers', '') }}"
                                       autocomplete="off">
                                
                                <!-- Autocomplete dropdown -->
                                <div id="autocomplete-dropdown" class="position-absolute w-100 bg-white border border-top-0 rounded-bottom shadow-sm" 
                                     style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto;">
                                </div>
                            </div>
                            <div class="form-text">
                                <strong>üîç Hae Data / üìä Hae YFinancesta:</strong> Anna t√§ysi symboli (AAPL) tai symbolin alku (AA)<br>
                                <strong>üìÑ Hae CSV:st√§:</strong> <span class="text-success">J√§t√§ tyhj√§ksi = MASSA-AJO (lataa kaikki CSV:ss√§ olevat osakkeet)</span><br>
                                <small class="text-primary">üí° Vinkki: Aloita kirjoittamaan n√§hd√§ksesi ehdotuksia</small>
                            </div>
                        </div>
                        
                        <!-- Ensimm√§inen rivi: Haku- ja lataus-painikkeet -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <form method="POST" action="/search" class="d-inline">
                                    <input type="hidden" name="tickers" id="search_tickers">
                                    <input type="hidden" name="db_type" id="search_db_type">
                                    <button type="submit" class="btn btn-primary w-100" onclick="copyTickersToSearch()">
                                        üîç Hae Data
                                    </button>
                                </form>
                            </div>
                            <div class="col-md-3">
                                <form method="POST" action="/fetch_yfinance" class="d-inline">
                                    <input type="hidden" name="tickers" id="yfinance_tickers">
                                    <button type="submit" class="btn btn-success w-100" onclick="copyTickersToYfinance()">
                                        üìà Hae YFinancesta
                                    </button>
                                </form>
                            </div>
                            <div class="col-md-3">
                                <form method="POST" action="/fetch_csv" class="d-inline">
                                    <input type="hidden" name="tickers" id="csv_tickers">
                                    <button type="submit" class="btn btn-info w-100" onclick="copyTickersToCSV()">
                                        üìÑ Hae CSVst√§
                                    </button>
                                </form>
                            </div>
                            <div class="col-md-3">
                                <form method="POST" action="/fetch_tickers" class="d-inline">
                                    <button type="submit" class="btn btn-warning w-100" id="fetch-tickers-btn">
                                        üìã Hae Tickerit
                                    </button>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Progress bar for ticker file processing -->
                        <div id="ticker-progress-container" class="row mt-3" style="display: none;">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="card-title mb-0">Ticker-tiedoston k√§sittely</h6>
                                            <button id="close-progress-btn" class="btn btn-sm btn-outline-secondary" onclick="closeProgressBar()" style="display: none;">
                                                ‚ùå Sulje
                                            </button>
                                        </div>
                                        <div class="progress mb-2">
                                            <div id="ticker-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                                 role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <div id="ticker-progress-text" class="text-center small text-muted">
                                            Aloitetaan...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Toinen rivi: Muut toiminnot -->
                        <div class="row">
                            <div class="col-md-6">
                                <form method="POST" action="/delete" class="d-inline" onsubmit="return confirmDeleteSimple()">
                                    <input type="hidden" name="delete_tickers" id="delete_tickers_hidden">
                                    <input type="hidden" name="db_type" id="delete_db_type">
                                    <input type="hidden" name="confirm_delete" id="confirm_delete_hidden" value="">
                                    <button type="submit" class="btn btn-danger w-100" onclick="copyTickersToDelete()">
                                        üóëÔ∏è Poista data
                                    </button>
                                    
                                    <!-- Varmistus-checkbox lomakkeen sis√§ll√§ -->
                                    <div class="form-check mt-3">
                                        <input class="form-check-input" type="checkbox" id="confirmDelete">
                                        <label class="form-check-label text-danger" for="confirmDelete">
                                            <strong>Vahvistan ett√§ haluan poistaa pysyv√§sti kaikki annettujen symbolien tiedot</strong>
                                        </label>
                                    </div>
                                </form>
                            </div>
                            <div class="col-md-6">
                                <form method="POST" action="/clear_database" onsubmit="return confirmClearDatabase()">
                                    <input type="hidden" name="db_type" id="clear_db_type">
                                    <input type="hidden" name="confirm_clear" id="confirm_clear_hidden" value="">
                                    <input type="hidden" name="double_confirm" id="double_confirm_hidden" value="">
                                    
                                    <button type="submit" class="btn btn-warning w-100" style="background-color: #dc2626; border-color: #dc2626; color: white;">
                                        üíÄ Tyhjenn√§ kaikki
                                    </button>
                                    
                                    <!-- Turvavarmistukset -->
                                    <div class="mt-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="confirmClear">
                                            <label class="form-check-label text-danger" for="confirmClear">
                                                <strong>Ymm√§rr√§n riskit - poista KAIKKI</strong>
                                            </label>
                                        </div>
                                        
                                        <div class="mt-2">
                                            <input type="text" class="form-control form-control-sm" 
                                                   id="doubleConfirmText" 
                                                   placeholder="Kirjoita: TYHJENN√Ñ"
                                                   style="border-color: #dc2626;">
                                            <small class="text-danger">Kirjoita 'TYHJENN√Ñ' vahvistaaksesi</small>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Symboli selain paranneltu isoille tietom√§√§rille -->
                <div class="card mt-3">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">{{ db_label or 'Symbolit tietokannassa' }}</h6>
                            <small class="text-muted" id="symbol-count">
                                {% if available_symbols %}{{ available_symbols|length }} symbolia{% endif %}
                            </small>
                        </div>
                        
                        <!-- Symbolien haku ja suodatus -->
                        <div class="mt-2">
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="symbol-search" 
                                       placeholder="Hae symbolia... (esim. AAPL, GOOGL)" 
                                       autocomplete="off">
                                <button class="btn btn-outline-secondary" type="button" id="clear-symbol-search">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <!-- Suodatimet -->
                            <div class="mt-2">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-primary active" data-filter="all">Kaikki</button>
                                    <button type="button" class="btn btn-outline-primary" data-filter="A-F">A-F</button>
                                    <button type="button" class="btn btn-outline-primary" data-filter="G-M">G-M</button>
                                    <button type="button" class="btn btn-outline-primary" data-filter="N-S">N-S</button>
                                    <button type="button" class="btn btn-outline-primary" data-filter="T-Z">T-Z</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <!-- Ladataan symbolit dynaamisesti -->
                        <div id="symbol-container">
                            <div class="text-center p-3">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Ladataan...</span>
                                </div>
                                <div class="mt-2">Ladataan symboleja...</div>
                            </div>
                        </div>
                        
                        <!-- Pagination -->
                        <div id="symbol-pagination" class="mt-3" style="display: none;">
                            <nav>
                                <ul class="pagination pagination-sm justify-content-center">
                                    <li class="page-item" id="prev-page">
                                        <a class="page-link" href="#" aria-label="Edellinen">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item active" id="page-1">
                                        <a class="page-link" href="#" data-page="1">1</a>
                                    </li>
                                    <li class="page-item" id="next-page">
                                        <a class="page-link" href="#" aria-label="Seuraava">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>

                {% if error %}
                <div class="error-box">
                    <strong>Virhe:</strong> {{ error }}
                </div>
                {% endif %}

                {% if success %}
                <div class="alert alert-success">
                    <strong>Onnistui!</strong> {{ success }}
                </div>
                {% endif %}

                {% if searched_terms %}
                <div class="info-box">
                    <strong>Hakutermit:</strong> {{ ', '.join(searched_terms) }}
                    {% if found_symbols %}
                        <br><strong>L√∂ytyneet symbolit:</strong> {{ ', '.join(found_symbols) }}
                    {% endif %}
                    {% if record_count %}
                        <br><strong>Yhteens√§ rivej√§:</strong> {{ record_count }}
                    {% endif %}
                </div>
                {% endif %}

                {% if table_html %}
                <div class="table-container">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Osakedata</h5>
                            <small class="text-muted">{{ record_count }} rivi√§</small>
                        </div>
                        <div class="card-body p-0">
                            {{ table_html|safe }}
                        </div>
                    </div>
                </div>
                {% endif %}

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Kopioi ticker-arvot ja tietokantavalinta piilokenttiin haku-lomakkeelle
        function copyTickersToSearch() {
            const tickers = document.getElementById('tickers').value;
            const dbType = document.getElementById('db_type').value;
            document.getElementById('search_tickers').value = tickers;
            document.getElementById('search_db_type').value = dbType;
        }

        // Kopioi ticker-arvot ja tietokantavalinta piilokenttiin poisto-lomakkeelle
        function copyTickersToDelete() {
            const tickers = document.getElementById('tickers').value;
            const dbType = document.getElementById('db_type').value;
            document.getElementById('delete_tickers_hidden').value = tickers;
            document.getElementById('delete_db_type').value = dbType;
        }

        // Kopioi ticker-arvot YFinance-lomakkeelle
        function copyTickersToYfinance() {
            const tickers = document.getElementById('tickers').value;
            document.getElementById('yfinance_tickers').value = tickers;
        }

        // Kopioi ticker-arvot CSV-lomakkeelle
        function copyTickersToCSV() {
            const tickers = document.getElementById('tickers').value;
            document.getElementById('csv_tickers').value = tickers;
        }

        // Handle ticker file processing with progress monitoring
        document.getElementById('fetch-tickers-btn').addEventListener('click', function(e) {
            e.preventDefault();
            
            const progressContainer = document.getElementById('ticker-progress-container');
            const progressBar = document.getElementById('ticker-progress-bar');
            const progressText = document.getElementById('ticker-progress-text');
            const button = this;
            
            // Show progress bar and disable button
            progressContainer.style.display = 'block';
            button.disabled = true;
            button.innerHTML = '‚è≥ K√§sitell√§√§n...';
            
            // Reset progress
            progressBar.style.width = '0%';
            progressBar.classList.remove('bg-success', 'bg-danger');
            progressBar.classList.add('progress-bar-animated');
            progressText.textContent = 'Aloitetaan ticker-tiedoston k√§sittely...';
            
            // Start the task
            fetch('/fetch_tickers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.task_id) {
                    // Start listening for progress updates
                    const eventSource = new EventSource(`/progress/${data.task_id}`);
                    
                    eventSource.onmessage = function(event) {
                        const progress = JSON.parse(event.data);
                        
                        // Update progress bar
                        const percentage = progress.total > 0 ? (progress.processed / progress.total * 100) : 0;
                        progressBar.style.width = `${percentage}%`;
                        
                        // Update progress text
                        if (progress.current_ticker) {
                            progressText.textContent = `K√§sitell√§√§n ${progress.current_ticker} (${progress.processed}/${progress.total}) - Onnistui: ${progress.success_count}, Ep√§onnistui: ${progress.error_count}, Hyl√§tty (penny): ${progress.penny_stock_count || 0}`;
                        }
                        
                        // Check if completed
                        if (progress.completed) {
                            eventSource.close();
                            
                            // Show close button when completed
                            document.getElementById('close-progress-btn').style.display = 'block';
                            
                            if (progress.success) {
                                progressBar.style.width = '100%';
                                progressBar.classList.remove('progress-bar-animated');
                                progressBar.classList.add('bg-success');
                                progressText.textContent = `Valmis! K√§sitelty ${progress.processed} tickeri√§ - Onnistui: ${progress.success_count}, Ep√§onnistui: ${progress.error_count}, Hyl√§tty (penny): ${progress.penny_stock_count || 0}`;
                            } else {
                                progressBar.classList.remove('progress-bar-animated');
                                progressBar.classList.add('bg-danger');
                                progressText.textContent = `Virhe: ${progress.message}`;
                                
                                // Re-enable button only on error
                                button.disabled = false;
                                button.innerHTML = 'üìã Hae Tickerit';
                            }
                        }
                    };
                    
                    eventSource.onerror = function(event) {
                        eventSource.close();
                        progressBar.classList.remove('progress-bar-animated');
                        progressBar.classList.add('bg-danger');
                        progressText.textContent = 'Virhe edistymisen seurannassa';
                        
                        // Show close button even on error
                        document.getElementById('close-progress-btn').style.display = 'block';
                    };
                } else {
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-danger');
                    progressText.textContent = `Virhe: ${data.message}`;
                    
                    // Show close button even on initial error
                    document.getElementById('close-progress-btn').style.display = 'block';
                }
            })
            .catch(error => {
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-danger');
                progressText.textContent = 'Virhe verkkoyhteydess√§';
                console.error('Error:', error);
                
                // Show close button even on network error
                document.getElementById('close-progress-btn').style.display = 'block';
            });
        });

        // Function to close progress bar manually
        function closeProgressBar() {
            const progressContainer = document.getElementById('ticker-progress-container');
            const closeBtn = document.getElementById('close-progress-btn');
            
            // Hide progress container
            progressContainer.style.display = 'none';
            
            // Hide close button for next time
            closeBtn.style.display = 'none';
            
            // Re-enable the fetch button
            const fetchBtn = document.getElementById('fetch-tickers-btn');
            fetchBtn.disabled = false;
            fetchBtn.innerHTML = 'üìã Hae Tickerit';
        }

                // P√§ivit√§ saatavilla olevat symbolit kun tietokantaa vaihdetaan
        function updateDatabase() {
            const dbType = document.getElementById('db_type').value;
            
            // P√§ivit√§ piilotetut kent√§t
            document.getElementById('search_db_type').value = dbType;
            document.getElementById('delete_db_type').value = dbType;
            document.getElementById('clear_db_type').value = dbType;
            
            // Lataa uudet symbolit
            loadSymbols();
        }        // Yksinkertainen varmistus checkboxilla
        function confirmDeleteSimple() {
            const tickers = document.getElementById('delete_tickers_hidden').value.trim();
            const checkbox = document.getElementById('confirmDelete');
            
            if (!tickers) {
                alert('Anna symbolit joita haluat poistaa!');
                return false;
            }
            
            if (!checkbox.checked) {
                alert('Rastita varmistusruutu vahvistaaksesi poiston!');
                checkbox.focus();
                return false;
            }
            
            // Aseta vahvistus piilotettuun kentt√§√§n
            document.getElementById('confirm_delete_hidden').value = 'kyll√§';
            
            return confirm(`Poistetaan KAIKKI tiedot symboleille: ${tickers}\n\nJatketaanko?`);
        }

        // VAARALLINEN TOIMINTO: Tietokannan tyhjent√§misen vahvistus
        function confirmClearDatabase() {
            const checkbox = document.getElementById('confirmClear');
            const confirmText = document.getElementById('doubleConfirmText').value.trim();
            const dbType = document.getElementById('db_type').value;
            
            if (!checkbox.checked) {
                alert('Rastita varmistusruutu vahvistaaksesi ett√§ ymm√§rr√§t riskit!');
                checkbox.focus();
                return false;
            }
            
            if (confirmText !== 'TYHJENN√Ñ') {
                alert('Kirjoita t√§sm√§lleen "TYHJENN√Ñ" vahvistaaksesi toiminnon!');
                document.getElementById('doubleConfirmText').focus();
                return false;
            }
            
            // Viimeinen varoitus
            const dbLabel = dbType === 'analysis' ? 'Analysis-tietokanta' : 'Osakedata-tietokanta';
            const finalConfirm = confirm(
                `‚ö†Ô∏è VIIMEINEN VAROITUS ‚ö†Ô∏è\n\n` +
                `Olet aikeissa TYHJENT√Ñ√Ñ KOKONAAN:\n${dbLabel}\n\n` +
                `T√§m√§ poistaa KAIKKI tiedot PYSYV√ÑSTI!\n` +
                `Toimintoa EI VOI PERUA!\n\n` +
                `Oletko t√§ysin varma ett√§ haluat jatkaa?`
            );
            
            if (!finalConfirm) {
                return false;
            }
            
            // Aseta piilotetut arvot
            document.getElementById('clear_db_type').value = dbType;
            document.getElementById('confirm_clear_hidden').value = 'kyll√§';
            document.getElementById('double_confirm_hidden').value = confirmText;
            
            return true;
        }

        // Symbolien hallinta suurille tietom√§√§rille
        let allSymbols = [];
        let filteredSymbols = [];
        let currentPage = 1;
        const symbolsPerPage = 100;
        let currentFilter = 'all';
        let symbolSearchTimeout = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            loadSymbols();
            setupAutocomplete();
            setupSymbolSearch();
            setupFilterButtons();
            
            // Enter-n√§pp√§in hakee dataa
            document.getElementById('tickers').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    copyTickersToSearch();
                    this.closest('.card-body').querySelector('form[action="/search"]').submit();
                }
            });

            // Scroll taulukkoon kun data ladattu
            {% if table_html %}
            setTimeout(() => {
                document.querySelector('.table-container')?.scrollIntoView({ behavior: 'smooth' });
            }, 100);
            {% endif %}

            // Kopioi l√∂ytyneet symbolit -nappi
            {% if found_symbols %}
            const copyButton = document.createElement('button');
            copyButton.type = 'button';
            copyButton.className = 'btn btn-sm btn-outline-primary mt-2';
            copyButton.innerHTML = 'üìã Kopioi l√∂ytyneet symbolit';
            copyButton.onclick = function() {
                const foundSymbols = {{ found_symbols | tojson }};
                document.getElementById('tickers').value = foundSymbols.join(', ');
            };
            
            document.querySelector('.info-box')?.appendChild(copyButton);
            {% endif %}
        });
        
        // Lataa symbolit API:sta
        function loadSymbols() {
            const dbType = document.getElementById('db_type').value;
            fetch(`/api/symbols?db_type=${dbType}`)
                .then(response => response.json())
                .then(symbols => {
                    allSymbols = symbols.sort();
                    filteredSymbols = [...allSymbols];
                    currentPage = 1;
                    updateSymbolCount();
                    renderSymbols();
                })
                .catch(error => {
                    console.error('Virhe symbolien lataamisessa:', error);
                    document.getElementById('symbol-container').innerHTML = 
                        '<div class="text-danger">Virhe symbolien lataamisessa</div>';
                });
        }
        
        // P√§ivit√§ symboli m√§√§r√§
        function updateSymbolCount() {
            document.getElementById('symbol-count').textContent = 
                `${filteredSymbols.length} / ${allSymbols.length} symbolia`;
        }
        
        // Render√∂i symbolit sivutettuna
        function renderSymbols() {
            const container = document.getElementById('symbol-container');
            const startIndex = (currentPage - 1) * symbolsPerPage;
            const endIndex = startIndex + symbolsPerPage;
            const pageSymbols = filteredSymbols.slice(startIndex, endIndex);
            
            if (pageSymbols.length === 0) {
                container.innerHTML = '<div class="text-muted p-3">Ei symboleita n√§ytett√§v√§n√§</div>';
                document.getElementById('symbol-pagination').style.display = 'none';
                return;
            }
            
            let html = '<div class="row g-1">';
            pageSymbols.forEach(symbol => {
                html += `<div class="col-auto">
                    <span class="symbol-badge badge bg-primary me-1 mb-1" 
                          style="cursor: pointer;" 
                          onclick="addSymbolToSearch('${symbol}')"
                          title="Klikkaa lis√§t√§ksesi hakuun">${symbol}</span>
                </div>`;
            });
            html += '</div>';
            
            container.innerHTML = html;
            
            // N√§yt√§ pagination jos tarvitaan
            if (filteredSymbols.length > symbolsPerPage) {
                renderPagination();
                document.getElementById('symbol-pagination').style.display = 'block';
            } else {
                document.getElementById('symbol-pagination').style.display = 'none';
            }
        }
        
        // Render√∂i sivutus
        function renderPagination() {
            const totalPages = Math.ceil(filteredSymbols.length / symbolsPerPage);
            const pagination = document.getElementById('symbol-pagination');
            
            let html = '<nav><ul class="pagination pagination-sm justify-content-center">';
            
            // Edellinen sivu
            html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})" aria-label="Edellinen">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>`;
            
            // Sivunumerot (n√§yt√§ max 5 sivua)
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, startPage + 4);
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>`;
            }
            
            // Seuraava sivu
            html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})" aria-label="Seuraava">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>`;
            
            html += '</ul></nav>';
            pagination.innerHTML = html;
        }
        
        // Vaihda sivu
        function changePage(page) {
            const totalPages = Math.ceil(filteredSymbols.length / symbolsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderSymbols();
            
            // Scroll symbol containeriin
            document.getElementById('symbol-container').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'nearest' 
            });
        }
        
        // Lis√§√§ symboli hakuun
        function addSymbolToSearch(symbol) {
            const tickersInput = document.getElementById('tickers');
            const currentValue = tickersInput.value.trim();
            
            if (currentValue === '') {
                tickersInput.value = symbol;
            } else {
                // Tarkista ettei symboli ole jo listassa
                const symbols = currentValue.split(',').map(s => s.trim());
                if (!symbols.includes(symbol)) {
                    tickersInput.value = currentValue + ', ' + symbol;
                }
            }
            
            // Focus input fieldiin
            tickersInput.focus();
        }
        
        // Symbolien haku
        function setupSymbolSearch() {
            const searchInput = document.getElementById('symbol-search');
            const clearBtn = document.getElementById('clear-symbol-search');
            
            searchInput.addEventListener('input', function() {
                clearTimeout(symbolSearchTimeout);
                symbolSearchTimeout = setTimeout(() => {
                    filterSymbols();
                }, 300);
            });
            
            clearBtn.addEventListener('click', function() {
                searchInput.value = '';
                filterSymbols();
                searchInput.focus();
            });
        }
        
        // Suodata symbolit
        function filterSymbols() {
            const searchTerm = document.getElementById('symbol-search').value.trim().toLowerCase();
            
            let filtered = allSymbols;
            
            // Haku suodatus
            if (searchTerm) {
                filtered = filtered.filter(symbol => 
                    symbol.toLowerCase().includes(searchTerm)
                );
            }
            
            // Aakkossuodatus
            if (currentFilter !== 'all') {
                filtered = filtered.filter(symbol => {
                    const firstChar = symbol.charAt(0).toUpperCase();
                    switch (currentFilter) {
                        case 'A-F': return firstChar >= 'A' && firstChar <= 'F';
                        case 'G-M': return firstChar >= 'G' && firstChar <= 'M';
                        case 'N-S': return firstChar >= 'N' && firstChar <= 'S';
                        case 'T-Z': return firstChar >= 'T' && firstChar <= 'Z';
                        default: return true;
                    }
                });
            }
            
            filteredSymbols = filtered;
            currentPage = 1;
            updateSymbolCount();
            renderSymbols();
        }
        
        // Suodatus painikkeet
        function setupFilterButtons() {
            document.querySelectorAll('[data-filter]').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Poista active class kaikista
                    document.querySelectorAll('[data-filter]').forEach(b => 
                        b.classList.remove('active'));
                    
                    // Lis√§√§ active class valittuun
                    this.classList.add('active');
                    
                    currentFilter = this.getAttribute('data-filter');
                    filterSymbols();
                });
            });
        }
        
        // Autocomplete setup
        function setupAutocomplete() {
            const tickersInput = document.getElementById('tickers');
            const dropdown = document.getElementById('autocomplete-dropdown');
            let autocompleteTimeout = null;
            
            tickersInput.addEventListener('input', function() {
                clearTimeout(autocompleteTimeout);
                autocompleteTimeout = setTimeout(() => {
                    showAutocomplete();
                }, 200);
            });
            
            // Piilota dropdown kun klikataan muualle
            document.addEventListener('click', function(e) {
                if (!tickersInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }
        
        // N√§yt√§ autocomplete ehdotukset
        function showAutocomplete() {
            const input = document.getElementById('tickers');
            const dropdown = document.getElementById('autocomplete-dropdown');
            const value = input.value.trim();
            
            if (value.length < 1) {
                dropdown.style.display = 'none';
                return;
            }
            
            // Ota viimeinen symboli pilkun j√§lkeen
            const symbols = value.split(',');
            const lastSymbol = symbols[symbols.length - 1].trim().toLowerCase();
            
            if (lastSymbol.length < 1) {
                dropdown.style.display = 'none';
                return;
            }
            
            // Etsi matchaavat symbolit
            const matches = allSymbols
                .filter(symbol => symbol.toLowerCase().startsWith(lastSymbol))
                .slice(0, 10); // Max 10 ehdotusta
            
            if (matches.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            // Render√∂i ehdotukset
            let html = '';
            matches.forEach(symbol => {
                html += `<div class="p-2 border-bottom autocomplete-item" 
                               style="cursor: pointer;" 
                               onclick="selectAutocomplete('${symbol}')">
                    <strong>${symbol}</strong>
                </div>`;
            });
            
            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        }
        
        // Valitse autocomplete ehdotus
        function selectAutocomplete(symbol) {
            const input = document.getElementById('tickers');
            const symbols = input.value.split(',');
            symbols[symbols.length - 1] = ' ' + symbol;
            input.value = symbols.join(',');
            
            document.getElementById('autocomplete-dropdown').style.display = 'none';
            input.focus();
        }
    </script>
</body>
</html>